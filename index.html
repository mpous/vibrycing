<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />

		<title>Vibrycing | WIP Jam MWC Barcelona 2013</title>

		<link rel="stylesheet" href="css/geo.css" type="text/css" />
		<script src="js/jquery-1.8.3/jquery-1.8.3.min.js" type="text/javascript"></script>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script type="text/javascript" src="js/geo.js"></script>
		<script type="text/javascript" src="js/vibrate.js"></script>
		<script type="text/javascript" src="js/algorithm.js"></script>
		
		<script type="text/javascript">
		
		$(document).ready(function() {
		
			 $("#form-lat-lng").submit(function() {
				calculateRoute();
				return false;
				});
				
		});
		
		
		</script>

	</head>
	<body>
		<section id="wrapper">
			<header>
				<h1>Vibrycing</h1>
			</header>
			<meta name="viewport" content="width=640" />
				<p style="padding-left:20px; padding-right:10px;">
					<strong>Vibrycing is an HTML5 app for cycling and find your route with vibration interaction!</strong>
					<br />
				</p>

				
				<article>
					<form id="form-lat-lng" action="#">
						<input type="hidden" name="lat_origin" id="lat_origin" />
						<input type="hidden" name="lon_origin" id="lon_origin" /> 
						<input type="hidden" name="lat_dest" id="lat_dest" />
						<input type="hidden" name="lon_dest" id="lon_dest" /> 
						<br />
						<span id="status"> searching...</span>
						<br />

						<input type="submit" value="Go"/>
					</form>
				</article>

		</section>
		<script src="js/prettify.min.js"></script>

		<p style="text-align:center; font-size:8pt;">
			Idea from <a href="http://marc.planaguma.net">Marc Planagum√†</a> and <a href="http://marcpous.com">Marc Pous</a>
		</p>

				<!-- Origin Destination Map code -->
				
				<script>
					var s = document.querySelector('#status');
					
					var lat_origin = document.querySelector('#lat_origin');
					var lon_origin = document.querySelector('#lon_origin');

					var lat_dest = document.querySelector('#lat_dest');
					var lon_dest = document.querySelector('#lon_dest');

					var map;

					var markersArray = [];

					function success(position) 
					{
						if (s.className == 'success') {
							// not sure why we're hitting this twice in FF, I think it's to do with a cached result coming back
							return;
						}
						s.innerHTML = "found!";
						s.className = 'success';
						
						lat_origin.value =   position.coords.latitude;
						lon_origin.value =   position.coords.longitude;

						lat_dest.value = position.coords.latitude;
						lon_dest.value = position.coords.longitude;

						var mapcanvas = document.createElement('div');
						mapcanvas.id = 'mapcanvas';
						mapcanvas.style.height = '400px';
						mapcanvas.style.width = '90%';
						
						document.querySelector('article').appendChild(mapcanvas);

						var latlng_origin = new google.maps.LatLng(lat_origin.value, lon_origin.value);
						var latlng_dest = new google.maps.LatLng(lat_dest.value, lon_dest.value);

						var myOptions = {
							zoom: 14,
							center: latlng_origin,
							mapTypeControl: false,
							navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
							mapTypeId: google.maps.MapTypeId.ROADMAP
						};
						
						map = new google.maps.Map(document.getElementById("mapcanvas"), myOptions);
						
						var marker = new google.maps.Marker({
							position: latlng_origin,
							map: map,
							title:"Origin!"
						});

						var marker2 = new google.maps.Marker({
							position:latlng_dest,
							map:map,
							title: "Destination!"
						});

						//markersArray.push(marker);
						markersArray.push(marker2);

						google.maps.event.addListener(map, 'click', function(event) {
						    addMarker(event.latLng);
						  });
					}

					function addMarker(location) {

						var coords = String(location).split(',');

						var lat = coords[0].trim();
						lat = String(lat).slice(1);
						var lon = coords[1].trim();
						lon = String(lon).slice(0, -1);
						
					  deleteOverlays();

					  marker = new google.maps.Marker({
					    position: location,
					    map: map
					  });

					  lat_dest.value = lat;
					  lon_dest.value = lon;

					  markersArray.push(marker);
					}

					// Deletes all markers in the array by removing references to them
					function deleteOverlays() {
					  if (markersArray) {
					    for (i in markersArray) {
					      markersArray[i].setMap(null);
					    }
					    markersArray.length = 0;
					  }
					}
					

					function error(msg) 
					{
						var s = document.querySelector('#status');
						s.innerHTML = typeof msg == 'string' ? msg : "failed";
						s.className = 'fail';
						// console.log(arguments);
					}

					if (navigator.geolocation) 
					{
						navigator.geolocation.getCurrentPosition(success, error);
					} 
					else 
					{
						error('Geolocation not supported');
					}
				</script>

				<!-- / First Map code -->

				<!-- Route calculation -->

				<script>
					function calculateRoute()
					{
						var lat_origin = $('#lat_origin').val();
						var lon_origin = $('#lon_origin').val();

						var lat_dest = $('#lat_dest').val();
						var lon_dest = $('#lon_dest').val();

						//startVibrate(100);

						/*
							
							* busquem el JSON amb la driving/walking route que ens torna Google
							* convertim el JSON en un objecte ruta amb steps
							* agafem el 1er step i el comparem amb la latitud i longituds actuals
							* si estem arribant al nextStep --> vibrar dreta o esquerra
							* seguim amb el bucle fins al final


						*/
						
						var google_maps_api_url = "http://maps.googleapis.com/maps/api/";
						var route;
						
						$.ajax({
							url: google_maps_api_url + "directions/json",
							data: {	
									sensor: "false",
									origin: lat_origin + "," + lon_origin , 
									destination: lat_dest + "," + lon_dest , 
									mode: "walking"
								  },
							success: function(data, textStatus) {
								
								// Fix on Firefox! "data" response is not a Object is a string
								if (!($.isPlainObject(data))){
									data = $.parseJSON(data);
								}
								
								if(data.status == "OK"){
									renderRoute(data);

								}else{
									alert("NO Route available: " + data.status);
								}
								
					
							},
							error: function(data) {
								alert("Google Maps Route Error: " + data);
							}
						}).done( function() {
						});
						
						

					}
				</script>

				<!-- / Route calculation -->

	</body>
</html>